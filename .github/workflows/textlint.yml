name: Scenario Quality Check with textlint

on:
  pull_request:
    paths:
      - 'negaboku-bevy/assets/scenarios/**/*.md'
      - '.textlintrc*.json'
      - 'package.json'
      - 'package-lock.json'
      - 'textlint-rules/**/*.js'
      - '.github/workflows/textlint.yml'
  push:
    branches:
      - main
    paths:
      - 'negaboku-bevy/assets/scenarios/**/*.md'
      - '.textlintrc*.json'
      - 'package.json'
      - 'package-lock.json'
      - 'textlint-rules/**/*.js'
      - '.github/workflows/textlint.yml'

jobs:
  textlint:
    name: ã‚·ãƒŠãƒªã‚ªå“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          # jqã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆJSONè§£æç”¨ï¼‰
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run textlint check (JSON output)
        id: textlint
        run: |
          echo "Running textlint on scenario files..."
          echo "Current directory: $(pwd)"
          echo "Available config files:"
          ls -la .textlintrc*
          echo "Target files:"
          find negaboku-bevy/assets/scenarios -name "*.md" -type f || echo "No scenario files found"

          # JSONå½¢å¼ã§textlintçµæœã‚’å–å¾—ï¼ˆfindä½¿ç”¨ã§ç¢ºå®Ÿã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šï¼‰
          SCENARIO_FILES=$(find negaboku-bevy/assets/scenarios -name "*.md" -type f | tr '\n' ' ')
          if [ -n "$SCENARIO_FILES" ]; then
            npx textlint -c .textlintrc-scenario.json --format json $SCENARIO_FILES > textlint-results.json 2>/dev/null || true
            npx textlint -c .textlintrc-scenario.json $SCENARIO_FILES > textlint-results.txt 2>&1 || true
          else
            echo "[]" > textlint-results.json
            echo "No scenario files to check" > textlint-results.txt
          fi

          # çµæœã‚’è¡¨ç¤º
          if [ -s textlint-results.txt ]; then
            echo "TextLint results:"
            cat textlint-results.txt
          else
            echo "No TextLint results found."
            echo "[]" > textlint-results.json
          fi

      - name: Count errors and warnings (JSON parsing)
        id: count-issues
        run: |
          if [ -f textlint-results.json ] && [ -s textlint-results.json ]; then
            # JSONçµæœã‚’jqã§å³å¯†ã«é›†è¨ˆï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
            ERROR_COUNT=$(cat textlint-results.json | jq -r '[.[] | .messages | length] | add // 0' 2>/dev/null || echo "0")
            WARNING_COUNT=0  # textlintã¯ç¾åœ¨warningåŒºåˆ†ãªã—
            FIXABLE_COUNT=$(cat textlint-results.json | jq -r '[.[] | .messages | map(select(.fix)) | length] | add // 0' 2>/dev/null || echo "0")

            # null ã‚„ç©ºæ–‡å­—åˆ—ã‚’0ã«å¤‰æ›
            ERROR_COUNT=${ERROR_COUNT:-0}
            WARNING_COUNT=${WARNING_COUNT:-0}
            FIXABLE_COUNT=${FIXABLE_COUNT:-0}

            # æ•°å€¤ãƒã‚§ãƒƒã‚¯
            if ! [[ "$ERROR_COUNT" =~ ^[0-9]+$ ]]; then ERROR_COUNT=0; fi
            if ! [[ "$WARNING_COUNT" =~ ^[0-9]+$ ]]; then WARNING_COUNT=0; fi
            if ! [[ "$FIXABLE_COUNT" =~ ^[0-9]+$ ]]; then FIXABLE_COUNT=0; fi

            echo "ERROR_COUNT=${ERROR_COUNT}" >> $GITHUB_ENV
            echo "WARNING_COUNT=${WARNING_COUNT}" >> $GITHUB_ENV
            echo "FIXABLE_COUNT=${FIXABLE_COUNT}" >> $GITHUB_ENV
            echo "ã‚¨ãƒ©ãƒ¼æ•°: ${ERROR_COUNT}, è­¦å‘Šæ•°: ${WARNING_COUNT}, è‡ªå‹•ä¿®æ­£å¯èƒ½: ${FIXABLE_COUNT}"
          else
            echo "ERROR_COUNT=0" >> $GITHUB_ENV
            echo "WARNING_COUNT=0" >> $GITHUB_ENV
            echo "FIXABLE_COUNT=0" >> $GITHUB_ENV
            echo "JSONçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã¾ãŸã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼æ•°ã‚’0ã¨ã—ã¦å‡¦ç†ã—ã¾ã™ã€‚"
          fi

      - name: Comment PR with results (forkå¯¾å¿œãƒ»é‡è¤‡é˜²æ­¢)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- textlint-bot-comment -->';

            // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes(marker) && comment.user.type === 'Bot'
            );

            let resultsContent = '';
            if (fs.existsSync('textlint-results.txt')) {
              resultsContent = fs.readFileSync('textlint-results.txt', 'utf8');
            }

            const errorCount = process.env.ERROR_COUNT || '0';
            const warningCount = process.env.WARNING_COUNT || '0';
            const fixableCount = process.env.FIXABLE_COUNT || '0';

            let status = 'âœ… **å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†**';
            let summary = 'ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';

            if (parseInt(errorCount) > 0) {
              status = 'âŒ **å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—**';
              summary = `ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã«${errorCount}å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚`;
            } else if (parseInt(warningCount) > 0) {
              status = 'âš ï¸ **å“è³ªãƒã‚§ãƒƒã‚¯è­¦å‘Š**';
              summary = `ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã«${warningCount}å€‹ã®è­¦å‘ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`;
            }

            let comment = `${marker}
            ## ${status}

            ${summary}

            ### ğŸ“Š ãƒã‚§ãƒƒã‚¯çµæœã‚µãƒãƒªãƒ¼
            - **ã‚¨ãƒ©ãƒ¼**: ${errorCount}ä»¶
            - **è­¦å‘Š**: ${warningCount}ä»¶
            - **è‡ªå‹•ä¿®æ­£å¯èƒ½**: ${fixableCount}ä»¶

            ### ğŸ”§ ä¿®æ­£æ–¹æ³•
            `;

            if (parseInt(fixableCount) > 0) {
              comment += `
            **è‡ªå‹•ä¿®æ­£å¯èƒ½ãªå•é¡ŒãŒã‚ã‚Šã¾ã™:**
            \`\`\`bash
            npm run textlint:fix
            \`\`\`
            `;
            }

            comment += `
            **æ‰‹å‹•ãƒã‚§ãƒƒã‚¯:**
            \`\`\`bash
            npm run textlint:check
            \`\`\`
            `;

            if (resultsContent && resultsContent.trim()) {
              comment += `
            ### ğŸ“ è©³ç´°çµæœ
            <details>
            <summary>textlintå®Ÿè¡Œçµæœã‚’è¡¨ç¤º</summary>

            \`\`\`
            ${resultsContent.substring(0, 4000)}${resultsContent.length > 4000 ? '\n... (truncated)' : ''}
            \`\`\`

            </details>
            `;
            }

            comment += `

            ---
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code) - Scenario Quality Management System
            `;

            if (existingComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload TextLint Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: textlint-results
          path: |
            textlint-results.json
            textlint-results.txt
          retention-days: 30

      - name: Fail job if errors found
        if: env.ERROR_COUNT != '0'
        run: |
          echo "âŒ textlint found ${ERROR_COUNT} errors in scenario files"
          echo "Please fix the errors before merging."
          exit 1

      - name: Success summary
        if: env.ERROR_COUNT == '0'
        run: |
          echo "âœ… ã‚·ãƒŠãƒªã‚ªå“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†"
          echo "ã‚¨ãƒ©ãƒ¼: ${ERROR_COUNT}ä»¶, è­¦å‘Š: ${WARNING_COUNT}ä»¶, è‡ªå‹•ä¿®æ­£å¯èƒ½: ${FIXABLE_COUNT}ä»¶"
